@implements IDisposable

@if (this.Visible)
{
    <div class="code-view">

        <pre>@this._CodeText</pre>

        <CornerButton Class="copy-button" OnClick="OnClickCopyButton">
            @(this._Copied ? "Copied" : "Copy")
        </CornerButton>

    </div>
}

@code
{
    [CascadingParameter]
    internal IServiceProvider Services { get; init; } = default!;

    [Parameter]
    public Story? Story { get; set; }

    [Parameter]
    public bool Visible { get; set; }

    private string? _SourceCodeText = null;

    private string? _CodeText;

    private bool _Copied = false;

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        if (this.Visible == true && this._SourceCodeText == null && this.Story != null)
        {
            this._SourceCodeText = await StoriesRazorSource.GetSourceCodeAsync(this.Story);
            this.UpdateCodeTextWithArgument();
        }
    }

    protected override void OnInitialized()
    {
        if (this.Story == null) throw new InvalidOperationException("Story is required");
        this.Story.Context.ArgumentChanged += this.Context_ArgumentChanged;
    }

    private ValueTask Context_ArgumentChanged()
    {
        this.UpdateCodeTextWithArgument();
        this.StateHasChanged();
        return ValueTask.CompletedTask;
    }

    private void UpdateCodeTextWithArgument()
    {
        this._CodeText = this._SourceCodeText;
        if (this.Story == null || this._SourceCodeText == null) return;
        this._CodeText = StoriesRazorSource.UpdateSourceTextWithArgument(Story, this._SourceCodeText);
    }

    private async Task OnClickCopyButton()
    {
        if (this._CodeText == null) return;

        await Services.GetRequiredService<HelperScript>().CopyTextToClipboardAsync(this._CodeText);
        this._Copied = true;
        this.StateHasChanged();

        await Task.Delay(1500);
        this._Copied = false;
    }

    public void Dispose()
    {
        if (this.Story != null) this.Story.Context.ArgumentChanged -= this.Context_ArgumentChanged;
    }
}
